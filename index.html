<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Content Approval Dashboard V2 ‚Äî Notion style</title>

<!-- Basic Notion-like fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#3b82f6;
  --accent-2:#2563eb;
  --success:#10b981;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.6);
  --shadow: 0 8px 20px rgba(16,24,40,0.06);
  --radius: 12px;
  --maxwidth: 1100px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  padding:32px;
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg,#f8fafc 0%, var(--bg) 100%);
  color:#0f172a;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.container{
  max-width:var(--maxwidth);
  margin: 0 auto;
}
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:18px;
}
.title {
  display:flex;
  gap:14px;
  align-items:center;
}
.logo {
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  color:white;
  width:52px;
  height:52px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  box-shadow: 0 6px 18px rgba(37,99,235,0.12);
  font-size:20px;
}
.h1 {
  font-size:20px;
  font-weight:700;
}
.h1 small{display:block;font-weight:500;color:var(--muted);font-size:13px;margin-top:4px}

.toolbar {
  display:flex;
  gap:10px;
  align-items:center;
}
.btn {
  padding:10px 14px;
  border-radius:10px;
  background:var(--card);
  border:1px solid rgba(15,23,42,0.04);
  box-shadow:var(--shadow);
  cursor:pointer;
  display:inline-flex;
  gap:8px;
  align-items:center;
  font-weight:600;
  color:#0f172a;
}
.btn.primary{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:white;
  border:none;
  box-shadow: 0 6px 18px rgba(59,130,246,0.14);
}
.subtitle {
  color:var(--muted);
  font-size:13px;
}

/* Grid of cards */
.grid {
  display:flex;
  flex-direction:column;
  gap:18px;
  margin-top:22px;
}

/* Card */
.card {
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
  overflow:hidden;
  border: 1px solid rgba(15,23,42,0.03);
}
.card-head{
  display:flex;
  gap:12px;
  align-items:flex-start;
  justify-content:space-between;
}
.meta {
  display:flex;
  gap:14px;
  align-items:center;
  color:var(--muted);
  font-size:13px;
}
.title-line{
  font-weight:700;
  font-size:16px;
  line-height:1.35;
  margin-bottom:6px;
}
.card-body{
  margin-top:12px;
  display:flex;
  gap:18px;
  align-items:flex-start;
}
.media {
  width:260px;
  min-width:160px;
  max-height:220px;
  border-radius:10px;
  overflow:hidden;
  background:#f3f4f6;
  display:flex;
  align-items:center;
  justify-content:center;
}
.media img, .media video { width:100%; height:100%; object-fit:cover; display:block; }
.content {
  flex:1;
}
.label { font-size:13px; color:var(--muted); margin-bottom:6px; display:flex; align-items:center; gap:8px; }
textarea {
  width:100%;
  min-height:120px;
  border-radius:8px;
  padding:12px;
  border:1px solid rgba(15,23,42,0.06);
  font-size:14px;
  resize:vertical;
  background: linear-gradient(180deg, rgba(255,255,255,1), rgba(250,250,250,1));
}
.controls {
  display:flex;
  gap:8px;
  margin-top:10px;
  align-items:center;
}
.small-btn {
  padding:8px 10px;
  border-radius:8px;
  background:#f8fafc;
  border:1px solid rgba(15,23,42,0.04);
  cursor:pointer;
  font-weight:600;
  color:#0f172a;
  display:inline-flex;
  gap:8px;
  align-items:center;
}
.small-btn.primary {
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:white;
  border:none;
}
.metrics {
  margin-top:12px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.metric {
  background:rgba(15,23,42,0.03);
  padding:8px 10px;
  border-radius:8px;
  font-size:13px;
  color:#0f172a;
}
.spinner{
  width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.3);border-top-color:white;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* responsive */
@media(max-width:880px){
  .media{ display:none }
  .card-body{ flex-direction:column }
}
.footer {
  margin-top:30px;
  color:var(--muted);
  font-size:13px;
  text-align:center;
}

/* small utilities */
.kv { font-size:13px; color:var(--muted) }
.badge { font-size:12px; padding:6px 8px; border-radius:8px; background:#eef2ff; color:var(--accent-2); }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <div class="logo">CD</div>
      <div>
        <div class="h1">Content Approval Dashboard V2</div>
        <div class="subtitle">Giao di·ªán Notion-like ¬∑ T·ª± ƒë·ªông load t·ª´ n8n ¬∑ Duy·ªát & Rewrite b·∫±ng AI</div>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn" id="refreshBtn" title="L√†m m·ªõi (reload t·ª´ server)">üîÑ Refresh</button>
      <a class="btn" id="downloadCsv" href="/mnt/data/Content-Planner - Plan.csv" download>üì• T·∫£i CSV</a>
      <button class="btn primary" id="autoReloadToggle" title="T·ª± ƒë·ªông load m·ªói 60s">‚è±Ô∏è AutoReload: OFF</button>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">¬© Content Dashboard ¬∑ K·∫øt n·ªëi: <span class="kv">pfktja.ezn8n.com</span></div>
</div>

<script>
/*
  Dashboard V2 JS
  - ch·ªânh API URLs t·∫°i ƒë√¢y
  - L∆∞u √Ω: ƒë∆∞·ªùng d·∫´n CSV local ƒë√£ ch√®n: /mnt/data/Content-Planner - Plan.csv
*/

const API_GET = "https://pfktja.ezn8n.com/webhook/api/posts";
const API_UPDATE = "https://pfktja.ezn8n.com/webhook/api/update";
const API_REWRITE = "https://pfktja.ezn8n.com/webhook/api/rewrite";

/* Local uploaded CSV path (kept as-is per your instruction) */
const LOCAL_CSV_PATH = "/mnt/data/Content-Planner - Plan.csv";

/* simple helpers */
const el = sel => document.querySelector(sel);
const create = (tag, cls) => { const d = document.createElement(tag); if (cls) d.className = cls; return d; };

let autoReload = false;
let autoReloadTimer = null;

/* compute metrics */
function metricsFromText(text){
  const words = text.trim().length ? text.trim().split(/\s+/).length : 0;
  const chars = text.length;
  const hashtags = (text.match(/#[\p{L}\p{N}_-]+/gu) || []).length;
  const hashtagRatio = words ? (hashtags/words).toFixed(3) : 0;
  // simple sentiment heuristic: positive vs negative word list
  const pos = ["tuy·ªát","t·ªët","y√™u","y√™u th√≠ch","xu·∫•t s·∫Øc","t·ªët","mi·ªÖn ph√≠","∆∞u ƒë√£i","khuy·∫øn m√£i","h·∫•p d·∫´n","ƒë·∫πp","ƒë·∫°t"];
  const neg = ["kh√¥ng","k√©m","t·ªá","lo l·∫Øng","h·ªèng","l·ªói","ch·∫≠m","ph√†n n√†n","kh√≥ ch·ªãu"];
  const low = text.toLowerCase();
  let score = 0;
  pos.forEach(w=> { if (low.includes(w)) score+=1; });
  neg.forEach(w=> { if (low.includes(w)) score-=1; });
  let sentiment = "Neutral";
  if (score>=2) sentiment = "Positive";
  else if (score<=-2) sentiment = "Negative";
  return { words, chars, hashtags, hashtagRatio, sentiment, score };
}

/* convert media_id to embeddable Google Drive view URL */
function mediaUrlFromId(id) {
    if (!id) return null;
    return `https://drive.google.com/uc?export=view&id=${id}`;
}

/* render one post card */
function renderPost(post){
  const card = create('div','card');
  // header
  const head = create('div','card-head');
  const left = create('div');
  const titleLine = create('div','title-line');
  titleLine.textContent = `#${post.post_id} ‚Äî ${post.title || '(No Title)'}`;
  left.appendChild(titleLine);

  const meta = create('div','meta');
  meta.innerHTML = `<span class="kv"><b>Page:</b> ${post.page || '-'}</span>
                    <span class="kv">‚Äî</span>
                    <span class="kv"><b>${post.platform || 'Platform'}</b></span>
                    <span style="width:10px"></span>
                    <span class="kv"><b>Ng√†y:</b> ${post.plan_date || '-'}</span>
                    <span class="kv">|</span>
                    <span class="kv"><b>Gi·ªù:</b> ${post.plan_time || '-'}</span>`;
  left.appendChild(meta);

  head.appendChild(left);

  const right = create('div');
  right.innerHTML = `<div class="badge">ID: ${post.post_id}</div>`;
  head.appendChild(right);

  card.appendChild(head);

  // body
  const body = create('div','card-body');
  // media
const mediaWrap = create('div','media');
const mediaUrl = mediaUrlFromId(post.media_id);

if (mediaUrl) {

    // n·∫øu l√† video
    if (/\.(mp4|mov|webm)$/i.test(post.media_id)) {
        const v = create('video');
        v.controls = true;
        v.src = mediaUrl;
        mediaWrap.appendChild(v);

    } else {
        // ·∫£nh
        const img = create('img');
        img.src = mediaUrl;
        img.alt = post.title || 'media';

        img.onerror = function() {
            this.style.display='none';
            mediaWrap.innerHTML = '<div style="padding:12px;color:var(--muted)">No preview</div>';
        };

        mediaWrap.appendChild(img);
    }

} else {
    mediaWrap.innerHTML = '<div style="padding:12px;color:var(--muted)">No media</div>';
}


  // content area
  const content = create('div','content');

  // caption label + textarea
  const label = create('div','label');
  label.innerHTML = 'üìù <b>Caption</b>';
  content.appendChild(label);

  const textarea = create('textarea');
  textarea.id = `caption-${post.post_id}`;
  textarea.placeholder = "Caption s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y. B·∫°n c√≥ th·ªÉ s·ª≠a ho·∫∑c nh·∫•n 'Rewrite' ƒë·ªÉ g·ªçi AI vi·∫øt m·ªõi.";
  textarea.value = post.caption || '';
  textarea.disabled = true;
  content.appendChild(textarea);

  // controls
  const ctr = create('div','controls');

  // edit toggle
  const editBtn = create('button','small-btn');
  editBtn.innerHTML = '‚úèÔ∏è Edit';
  editBtn.onclick = () => {
    const t = textarea;
    t.disabled = !t.disabled;
    if(!t.disabled) {
      editBtn.classList.add('primary');
      editBtn.textContent = 'üíæ Save (Local)';
    } else {
      editBtn.classList.remove('primary');
      editBtn.textContent = '‚úèÔ∏è Edit';
      // if we toggled to disabled -> save to server
      saveCaption(post.post_id, t.value).then(ok=>{
        if(ok) {
          // update UI metrics
          updateMetricsDisplay(post.post_id);
        }
      });
    }
  };

  // rewrite button (call AI)
  const rewriteBtn = create('button','small-btn');
  rewriteBtn.innerHTML = '‚ú® Rewrite';
  rewriteBtn.onclick = async () => {
    // show loading
    const old = rewriteBtn.innerHTML;
    rewriteBtn.classList.add('primary');
    rewriteBtn.disabled = true;
    rewriteBtn.innerHTML = '<span class="spinner"></span> AI writing...';
    try {
      const newCaption = await requestRewrite(post);
      if(newCaption){
        textarea.value = newCaption;
        // auto-save to server after rewrite
        const ok = await saveCaption(post.post_id, newCaption, 'approved');
        if(ok) updateMetricsDisplay(post.post_id);
      } else {
        alert('Rewrite failed (no response).');
      }
    } catch(e){
      console.error(e);
      alert('Rewrite error: ' + e.message);
    } finally {
      rewriteBtn.disabled = false;
      rewriteBtn.classList.remove('primary');
      rewriteBtn.innerHTML = old;
    }
  };

  // manual save button (if user edited but wants explicit save)
  const saveBtn = create('button','small-btn primary');
  saveBtn.innerHTML = 'üíæ L∆∞u & C·∫≠p nh·∫≠t';
  saveBtn.onclick = async () => {
    const ok = await saveCaption(post.post_id, textarea.value, 'approved');
    if(ok) {
      textarea.disabled = true;
      editBtn.classList.remove('primary');
      editBtn.textContent = '‚úèÔ∏è Edit';
      updateMetricsDisplay(post.post_id);
      alert('Saved!');
    }
  };

  ctr.appendChild(editBtn);
  ctr.appendChild(rewriteBtn);
  ctr.appendChild(saveBtn);

  content.appendChild(ctr);

  // metrics box
  const metricsDiv = create('div','metrics');
  metricsDiv.id = `metrics-${post.post_id}`;
  const m = metricsFromText(textarea.value || '');
  metricsDiv.innerHTML = `<div class="metric">üìù ${m.words} t·ª´</div>
                          <div class="metric">üî† ${m.chars} k√Ω t·ª±</div>
                          <div class="metric">#Ô∏è‚É£ ${m.hashtags} hashtag</div>
                          <div class="metric">üìä t·ªâ l·ªá: ${m.hashtagRatio}</div>
                          <div class="metric">üòä C·∫£m x√∫c: ${m.sentiment}</div>`;
  content.appendChild(metricsDiv);

  // append body parts
  body.appendChild(mediaWrap);
  body.appendChild(content);
  card.appendChild(body);

  // attach to grid
  return card;
}

/* update metrics for given post id */
function updateMetricsDisplay(postId){
  const t = document.getElementById(`caption-${postId}`);
  if(!t) return;
  const m = metricsFromText(t.value || '');
  const node = document.getElementById(`metrics-${postId}`);
  if(node) {
    node.innerHTML = `<div class="metric">üìù ${m.words} t·ª´</div>
                      <div class="metric">üî† ${m.chars} k√Ω t·ª±</div>
                      <div class="metric">#Ô∏è‚É£ ${m.hashtags} hashtag</div>
                      <div class="metric">üìä t·ªâ l·ªá: ${m.hashtagRatio}</div>
                      <div class="metric">üòä C·∫£m x√∫c: ${m.sentiment}</div>`;
  }
}

/* load posts from API */
async function load(){
  const grid = el('#grid');
  grid.innerHTML = '<div style="padding:20px;color:var(--muted)">ƒêang t·∫£i b√†i...</div>';
  try {
    const res = await fetch(API_GET, {cache:'no-store'});
    if(!res.ok) throw new Error('API GET l·ªói: ' + res.status);
    const json = await res.json();
    const posts = json.posts || [];
    if(!posts.length){
      grid.innerHTML = '<div style="padding:20px;color:var(--muted)">Kh√¥ng c√≥ b√†i h√¥m nay.</div>';
      return;
    }
    grid.innerHTML = '';
    posts.forEach(p => {
      const card = renderPost(p);
      grid.appendChild(card);
    });

    // add event listeners for textarea input to update metrics on the fly
    document.querySelectorAll('textarea[id^="caption-"]').forEach(txt=>{
      txt.addEventListener('input', e=>{
        const id = txt.id.replace('caption-','');
        updateMetricsDisplay(id);
      });
    });
  } catch(err){
    console.error(err);
    el('#grid').innerHTML = `<div style="padding:20px;color:var(--danger)">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu: ${err.message}</div>`;
  }
}

/* save caption to server via API_UPDATE
   status default 'approved' unless provided */
async function saveCaption(post_id, caption, status='approved'){
  try {
    const payload = { post_id, caption, status };
    const res = await fetch(API_UPDATE, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('Update API l·ªói ' + res.status);
    const data = await res.json();
    return data.success === true || data.success === undefined; // accept both
  } catch(err){
    console.error(err);
    alert('L∆∞u th·∫•t b·∫°i: ' + err.message);
    return false;
  }
}

/* request rewrite from server (API_REWRITE) - expects {caption: "..."} or plain text */
async function requestRewrite(post){
  try {
    const body = {
      post_id: post.post_id,
      title: post.title,
      topic: post.topic,
      goal: post.goal,
      style: post.style,
      audience: post.audience,
      content_elements: post.content_elements || post.content || ''
    };
    const res = await fetch(API_REWRITE, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error('Rewrite API l·ªói ' + res.status);
    const data = await res.json();
    // response shape can vary; support multiple forms
    if(typeof data === 'object'){
      if(data.caption) return data.caption;
      if(data.text) return data.text;
      if(data.output) return data.output;
      if(Array.isArray(data) && data[0] && data[0].caption) return data[0].caption;
    }
    // fallback: if server returns plain text
    if(typeof data === 'string') return data;
    return null;
  } catch(err){
    console.error('Rewrite error', err);
    throw err;
  }
}

/* UI event bindings */
el('#refreshBtn').addEventListener('click', ()=> load());
el('#downloadCsv').setAttribute('href', LOCAL_CSV_PATH);

el('#autoReloadToggle').addEventListener('click', ()=>{
  autoReload = !autoReload;
  el('#autoReloadToggle').textContent = `‚è±Ô∏è AutoReload: ${autoReload ? 'ON' : 'OFF'}`;
  if(autoReload){
    autoReloadTimer = setInterval(()=> load(), 60000);
  } else {
    clearInterval(autoReloadTimer);
  }
});

/* initial load */
load();

/* expose a global reload for console debugging */
window.reloadDashboard = load;
</script>
</body>
</html>
