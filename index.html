<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Content Dashboard V2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f7fb;
  margin: 0;
  padding: 20px;
}
h1 {
  text-align: center;
  font-size: 28px;
  margin-bottom: 20px;
}
.post {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 20px;
  margin-bottom: 25px;
}
.row-title {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 10px;
}
select, textarea {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  margin-top: 8px;
  border: 1px solid #ccc;
}
textarea {
  height: 120px;
}
.button {
  margin-top: 15px;
  padding: 12px;
  background: #007bff;
  color: white;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  font-weight: bold;
}
.button:active {
  opacity: 0.7;
}
.caption-choice {
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>üìã Content Approval Dashboard V2</h1>

<div id="posts"></div>

<script>
const API_GET_POSTS = "https://pfktja.ezn8n.com/api/posts";
const API_UPDATE_POST = "https://pfktja.ezn8n.com/api/update";

/* Load posts */
async function loadPosts() {
    try {
        const res = await fetch(API_GET_POSTS);
        const data = await res.json();

        if (!data.posts || data.posts.length === 0) {
            document.getElementById("posts").innerHTML = "<p>Kh√¥ng c√≥ b√†i n√†o h√¥m nay.</p>";
            return;
        }

        renderPosts(data.posts);
    } catch (e) {
        console.error(e);
        alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i t·ª´ n8n API!");
    }
}

function renderPosts(posts) {
    const container = document.getElementById("posts");
    container.innerHTML = "";

    posts.forEach(post => {
        const div = document.createElement("div");
        div.className = "post";

        div.innerHTML = `
            <div class="row-title">#${post.post_id} ‚Äî ${post.title}</div>
            <p><b>Page:</b> ${post.page} ‚Äî <b>${post.platform}</b></p>
            <p><b>Ng√†y:</b> ${post.plan_date} ‚Äî <b>Gi·ªù:</b> ${post.plan_time}</p>

            <label>üìù Ch·ªçn Caption</label>
            <select class="caption-choice" onchange="updateTextarea(this, '${post.post_id}')">
                <option value="">‚Äî Ch·ªçn Caption ‚Äî</option>
                ${post.captionA ? `<option value="${encodeURIComponent(post.captionA)}">Caption A</option>` : ""}
                ${post.captionB ? `<option value="${encodeURIComponent(post.captionB)}">Caption B</option>` : ""}
                ${post.captionC ? `<option value="${encodeURIComponent(post.captionC)}">Caption C</option>` : ""}
            </select>

            <textarea id="caption-${post.post_id}" placeholder="Ch·ªçn caption ·ªü m·ª•c tr√™n ho·∫∑c ch·ªânh s·ª≠a t·∫°i ƒë√¢y"></textarea>

            <div class="button" onclick='savePost(${JSON.stringify(post)})'>üíæ L∆∞u & C·∫≠p nh·∫≠t</div>
        `;

        container.appendChild(div);
    });
}

function updateTextarea(select, postId) {
    const value = decodeURIComponent(select.value);
    document.getElementById("caption-" + postId).value = value;
}

/* Save post */
async function savePost(post) {
    const caption = document.getElementById("caption-" + post.post_id).value;

    if (!caption.trim()) {
        alert("B·∫°n ch∆∞a nh·∫≠p caption!");
        return;
    }

    const payload = {
        post_id: post.post_id,
        caption: caption,
        status: "approved"
    };

    try {
        const res = await fetch(API_UPDATE_POST, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
        } else {
            alert("C√≥ l·ªói khi l∆∞u!");
        }
    } catch (e) {
        alert("Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu v·ªÅ n8n!");
        console.error(e);
    }
}

loadPosts();
</script>

</body>
</html>
