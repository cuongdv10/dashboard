<!DOCTYPE html>
<html lang="vi" x-data="dashboardApp()" class="bg-gray-100">
<head>
  <meta charset="UTF-8">
  <title>Content Review Dashboard 2.0</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Animate style -->
  <style>
    .fade-in { animation: fadeIn .4s ease-in-out; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-50">
    <h1 class="text-2xl font-bold">üìã Content Review Dashboard 2.0</h1>

    <div class="flex gap-3">
      <button @click="reloadPosts()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
        Reload Posts
      </button>
      <button @click="toggleDark()"
        class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
        üåô
      </button>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-1">

    <!-- CARD -->
    <template x-for="post in posts" :key="post.post_id">
      <div class="bg-white shadow-md rounded-xl p-5 fade-in flex flex-col">

        <!-- MEDIA -->
        <div class="w-full h-56 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
          <template x-if="post.media_url">
            <img :src="post.media_url"
                 class="w-full h-full object-cover"
                 @error="post.media_url=null" />
          </template>

          <template x-if="!post.media_url">
            <div class="text-gray-500 text-sm">
              ‚è≥ Loading media...
              <button @click="loadMedia(post)" class="underline text-blue-600">
                reload
              </button>
            </div>
          </template>
        </div>

        <!-- META -->
        <h2 class="text-xl font-semibold mt-3" x-text="post.title"></h2>
        <p class="text-gray-500 text-sm" x-text="'üìÜ ' + post.plan_date + ' ‚Ä¢ ' + post.plan_time"></p>
        <p class="text-gray-500 text-sm" x-text="'üåê ' + post.platform + ' ‚Äî ' + post.page"></p>

        <!-- CAPTIONS -->
        <div class="mt-4">
          <h3 class="font-bold mb-2">üìù AI Captions</h3>

          <template x-for="c in ['A','B','C']">
            <button 
              @click="selectCaption(post, c)"
              class="block w-full text-left border rounded p-3 mb-2 hover:bg-gray-50"
              :class="post.selected === c ? 'border-blue-600 bg-blue-50' : ''">
              <span class="font-bold">Version {{c}}</span>
              <p class="text-sm mt-1" x-text="post['caption' + c]"></p>
            </button>
          </template>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="mt-4 flex gap-3">
          <button @click="approve(post)"
                  class="flex-1 bg-green-600 text-white p-2 rounded hover:bg-green-700">
            ‚úî Approve
          </button>

          <button @click="reject(post)"
                  class="flex-1 bg-red-600 text-white p-2 rounded hover:bg-red-700">
            ‚úñ Reject
          </button>
        </div>

      </div>
    </template>

  </main>


  <!-- ALPINE APP LOGIC -->
  <script>
    function dashboardApp() {
      return {

        posts: [],

        async init() {
          await this.reloadPosts();
        },

        // Toggle dark mode
        toggleDark() {
          document.documentElement.classList.toggle('dark');
        },

        // Load posts from n8n API
        async reloadPosts() {
          try {
            const res = await fetch("https://pfktja.ezn8n.com/webhook-test/api/posts");
            const data = await res.json();

            this.posts = data.posts.map(p => ({
              ...p,
              selected: null,
              media_url: null
            }));

            this.posts.forEach(p => this.loadMedia(p));

          } catch (e) {
            alert("‚ö† Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch b√†i!");
          }
        },

        // Load image/video from n8n
        loadMedia(post) {
          if (!post.media_id) return;
          post.media_url = `https:/pfktja.ezn8n.com/webhook/media?file_id=${post.media_id}`;
        },

        // Select caption A/B/C
        selectCaption(post, version) {
          post.selected = version;
        },

        // Approve
        async approve(post) {
          if (!post.selected) {
            alert("‚ö† H√£y ch·ªçn 1 version caption tr∆∞·ªõc!");
            return;
          }

          await fetch("https://pfktja.ezn8n.com/webhook/submit-review", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              post_id: post.post_id,
              action: "approve",
              caption_version: post.selected
            })
          });

          alert("ƒê√£ duy·ªát!");
        },

        // Reject
        async reject(post) {
          await fetch("https://pfktja.ezn8n.com/webhook/submit-review", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              post_id: post.post_id,
              action: "reject"
            })
          });

          alert("ƒê√£ t·ª´ ch·ªëi!");
        }
      }
    }
  </script>

</body>
</html>
