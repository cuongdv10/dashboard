<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Content Dashboard V3 ‚Äî Final</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#2563eb;
  --accent-2:#06b6d4;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --radius:12px;
  --shadow: 0 10px 30px rgba(14,30,37,0.06);
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);margin:0;color:#0f172a}
.wrap{max-width:1150px;margin:26px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;box-shadow:0 6px 18px rgba(37,99,235,0.12)}
h1{font-size:20px;margin:0}
.sub{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:12px;align-items:center}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
.btn-alt{background:#fff;border:1px solid #e6e8ee;padding:8px 12px;border-radius:10px;cursor:pointer}
.filters{display:flex;gap:8px;align-items:center}
.chip{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid transparent;cursor:pointer;font-size:14px}
.chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.status{font-size:13px;color:var(--muted);margin-bottom:12px}

/* list & cards */
.list{display:flex;flex-direction:column;gap:18px}
.card-wrap{display:block}
.card{display:flex;gap:18px;background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);align-items:flex-start;overflow:hidden}
.left{width:280px;min-width:220px}
.right{flex:1}
.meta{font-size:13px;color:var(--muted);margin-bottom:8px}
.title{font-weight:600;margin:0 0 8px 0;font-size:16px}
.media{border-radius:8px;overflow:hidden;background:#fafafa;width:100%;height:160px;display:flex;align-items:center;justify-content:center;border:1px solid #f0f2f5}
.media img, .media video, .media iframe{width:100%;height:100%;object-fit:contain;display:block;border:0}
.caption{width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid #e6e8ee;font-size:14px;resize:vertical}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:13px;color:var(--muted)}
.field input, .field select, textarea{padding:10px;border-radius:8px;border:1px solid #e6e8ee;font-size:14px}
.actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn-sm{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-edit{background:#eef2ff;color:#0b3b8c}
.btn-rewrite{background:var(--warning);color:#fff}
.btn-save{background:var(--success);color:#fff}
.small{font-size:13px;color:var(--muted)}
.badge{display:inline-block;padding:6px 8px;border-radius:8px;background:#f3f4f6;color:#111;font-size:12px;margin-left:6px}

/* platform color indicator */
.platform-facebook .card{border-left:8px solid #1877f2}
.platform-instagram .card{border-left:8px solid #fb4386}
.platform-tiktok .card{border-left:8px solid #111}

/* responsive */
@media (max-width:1000px){
  .card{flex-direction:column}
  .left{width:100%;min-width:unset}
  .media{height:220px}
  .grid{grid-template-columns:1fr}
  header{flex-direction:column;align-items:flex-start;gap:12px}
}

/* overlay loading */
.overlay {
  position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:9999;
}
.loader {
  background:#fff;padding:16px;border-radius:12px;display:flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(2,6,23,0.2)
}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:36px;height:36px;border-radius:50%;border:4px solid #eee;border-top-color:var(--accent);animation:spin 1s linear infinite}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">CD</div>
      <div>
        <h1>Content Dashboard V3 ‚Äî Final</h1>
        <div class="sub">Notion-like ¬∑ Dynamic fields t·ª´ Google Sheets ¬∑ Preview ·∫£nh/video ¬∑ Rewrite AI ¬∑ Inline edit</div>
      </div>
    </div>

    <div class="controls">
      <div class="filters" id="filterBar">
        <div class="chip active" data-plat="all">T·∫•t c·∫£</div>
        <div class="chip" data-plat="Facebook">Facebook</div>
        <div class="chip" data-plat="Instagram">Instagram</div>
        <div class="chip" data-plat="Tiktok">TikTok</div>
      </div>
      <button class="btn" id="btnRefresh">üîÑ Refresh</button>
    </div>
  </header>

  <div id="status" class="status">‚è≥ Chu·∫©n b·ªã...</div>
  <div id="postList" class="list"></div>

  <div style="margin-top:18px;font-size:13px;color:var(--muted)">
    Sample local CSV: <a href="/mnt/data/Content-Planner - Plan.csv" target="_blank">/mnt/data/Content-Planner - Plan.csv</a>
  </div>
</div>

<!-- overlay -->
<div id="overlay" class="overlay">
  <div class="loader">
    <div class="spinner"></div>
    <div><strong>ƒêang x·ª≠ l√Ω ‚Äî ch·ªù AI tr·∫£ n·ªôi dung...</strong></div>
  </div>
</div>

<script>
/* CONFIG - s·ª≠a endpoint khi deploy */
const API_FIELDS = "https://pfktja.ezn8n.com/webhook/api/fields";
const API_POSTS  = "https://pfktja.ezn8n.com/webhook/api/posts";
const API_UPDATE = "https://pfktja.ezn8n.com/webhook/api/update";
const API_REWRITE = "https://pfktja.ezn8n.com/webhook/api/rewrite";

/* state */
let FIELD_OPTIONS = {};
let POSTS = [];
let CURRENT_FILTER = 'all';

/* helper fetch JSON with errors */
async function fetchJson(url, opts){
  const res = await fetch(url, opts);
  if(!res.ok){
    const txt = await res.text().catch(()=>null);
    throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
  }
  return res.json();
}

/* normalize google drive id or url */
function extractDriveId(val){
  if(!val) return null;
  // if full url with /d/ID/
  const m = (''+val).match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if(m) return m[1];
  // url param id=
  const m2 = (''+val).match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if(m2) return m2[1];
  // plain id?
  if(/^[a-zA-Z0-9_-]{10,}$/.test(val)) return val;
  // fallback null
  return null;
}

/* build preview URL - use thumbnail for images; iframe preview for video */
function buildPreviewUrl(media_id, media_type) {
  const id = extractDriveId(media_id);
  if(!id) return null;
  // Always use thumbnail for image preview (fast)
  if(media_type && media_type.toLowerCase().includes('video')) {
    return { type:'video', url: `https://drive.google.com/file/d/${id}/preview` };
  }
  // else image - thumbnail endpoint
  return { type:'image', url: `https://drive.google.com/thumbnail?id=${id}` };
}

/* load field values from API */
async function loadFields(){
  try{
    document.getElementById('status').innerText = '‚è≥ T·∫£i dropdown fields...';
    const data = await fetchJson(API_FIELDS, {cache:'no-store'});
    FIELD_OPTIONS = data.fields || {};
    document.getElementById('status').innerText = '‚úÖ Fields s·∫µn s√†ng';
  }catch(err){
    console.error('loadFields', err);
    FIELD_OPTIONS = {};
    document.getElementById('status').innerText = '‚ö† L·ªói load fields: ' + err.message;
  }
}

/* load posts from API */
async function loadPosts(){
  try{
    document.getElementById('status').innerText = '‚è≥ T·∫£i posts...';
    const data = await fetchJson(API_POSTS, {cache:'no-store'});
    POSTS = data.posts || [];
    renderPosts(POSTS);
    document.getElementById('status').innerText = `‚úÖ ƒê√£ t·∫£i ${POSTS.length} b√†i`;
  }catch(err){
    console.error('loadPosts', err);
    POSTS = [];
    document.getElementById('postList').innerHTML = '';
    document.getElementById('status').innerText = '‚ö† L·ªói load posts: ' + err.message;
  }
}

/* Build select HTML or fallback input for a field (scoped to a card) */
function buildFieldControl(fieldKey, currentValue, postId){
  const opts = FIELD_OPTIONS[fieldKey] || [];
  const idAttr = `data-field="${fieldKey}" data-post="${postId}"`;
  if(Array.isArray(opts) && opts.length>0){
    let html = `<select ${idAttr} class="field-input">`;
    html += `<option value="">‚Äî (ch·ªçn) ‚Äî</option>`;
    opts.forEach(o=>{
      const safe = (o||'').toString().replaceAll('"','&quot;');
      html += `<option value="${safe}" ${safe===currentValue ? 'selected' : ''}>${safe}</option>`;
    });
    html += `</select>`;
    return html;
  } else {
    return `<input ${idAttr} value="${(currentValue||'').toString().replaceAll('"','&quot;')}" />`;
  }
}

/* render all posts */
function renderPosts(posts){
  const wrap = document.getElementById('postList');
  wrap.innerHTML = '';
  if(!posts.length){
    wrap.innerHTML = '<div class="small">Kh√¥ng c√≥ b√†i.</div>';
    return;
  }

  posts.forEach(post=>{
    const cardWrap = document.createElement('div'); cardWrap.className = `card-wrap platform-${(post.platform||'').toLowerCase()}`;
    const card = document.createElement('div'); card.className = 'card';

    // LEFT
    const left = document.createElement('div'); left.className = 'left';
    const idBadge = document.createElement('div'); idBadge.className = 'meta'; idBadge.innerHTML = `ID <span class="badge">${post.post_id}</span>`;
    const title = document.createElement('div'); title.className='title'; title.innerText = post.title || '';
    const pageLine = document.createElement('div'); pageLine.className='meta'; pageLine.innerHTML = `${post.page || ''} ‚Äî <strong>${post.platform || ''}</strong>`;
    const dateLine = document.createElement('div'); dateLine.className='meta';
    const timeValue = (post.plan_time||'').split(':').slice(0,2).join(':');
    dateLine.innerHTML = `Ng√†y: ${post.plan_date || '-'} ‚Ä¢ Gi·ªù: <input type="time" value="${timeValue||''}" data-time="${post.post_id}" />`;

    // media
    const mediaBox = document.createElement('div'); mediaBox.className='media';
    const preview = buildPreviewUrl(post.media_url || post.media_id, post.media_type);
    if(preview && preview.url){
      if(preview.type === 'video'){
        // use iframe preview (drive preview)
        const iframe = document.createElement('iframe');
        iframe.src = preview.url;
        iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture');
        iframe.setAttribute('loading','lazy');
        mediaBox.appendChild(iframe);
      } else {
        const img = document.createElement('img');
        img.src = preview.url;
        img.alt = post.title || 'media';
        img.onerror = function(){ this.style.display = 'none'; mediaBox.innerHTML = `<div style="padding:12px;color:var(--muted)">Kh√¥ng xem ƒë∆∞·ª£c ·∫£nh</div>`};
        mediaBox.appendChild(img);
      }
    } else {
      mediaBox.innerHTML = `<div style="padding:12px;color:var(--muted)">No media</div>`;
    }

    left.appendChild(idBadge);
    left.appendChild(title);
    left.appendChild(pageLine);
    left.appendChild(dateLine);
    left.appendChild(mediaBox);

    // RIGHT
    const right = document.createElement('div'); right.className = 'right';

    // dynamic fields row
    const grid = document.createElement('div'); grid.className='grid';
    const mapKeys = [
      {key:'topic', label:'Topic', val: post.topic || post.Topic || ''},
      {key:'goal', label:"Post's goal", val: post["Post's goal"] || post.goal || ''},
      {key:'style', label:'Desired style', val: post["Desired style"] || post.style || ''},
      {key:'audience', label:'Target audience', val: post["Target audience"] || post.audience || ''},
      {key:'format', label:'Output Format', val: post["Output Format"] || post.output_format || post.output || ''}
    ];
    mapKeys.forEach(m=>{
      const f = document.createElement('div'); f.className='field';
      const lab = document.createElement('label'); lab.innerText = m.label;
      const control = document.createElement('div');
      control.innerHTML = buildFieldControl(m.key, m.val, post.post_id);
      f.appendChild(lab); f.appendChild(control);
      grid.appendChild(f);
    });

    // caption
    const capLabel = document.createElement('div'); capLabel.className='meta'; capLabel.style.marginTop='12px'; capLabel.innerText='Caption';
    const textarea = document.createElement('textarea'); textarea.className='caption'; textarea.id = `cap_${post.post_id}`;
    textarea.value = post.caption || post["Post Content"] || '';
    textarea.addEventListener('input', ()=>updateStats(post.post_id, textarea.value));

    // stats
    const stats = document.createElement('div'); stats.className='small'; stats.style.marginTop='8px';
    stats.innerHTML = `S·ªë t·ª´: <span id="wc_${post.post_id}">0</span> ‚Ä¢ K√Ω t·ª±: <span id="cc_${post.post_id}">0</span>`;

    // actions
    const actions = document.createElement('div'); actions.className='actions';
    const btnEdit = document.createElement('button'); btnEdit.className='btn-sm btn-edit'; btnEdit.innerText='‚úè Edit'; btnEdit.onclick = ()=> textarea.focus();
    const btnRewrite = document.createElement('button'); btnRewrite.className='btn-sm btn-rewrite'; btnRewrite.innerText='üîÅ Rewrite';
    btnRewrite.onclick = ()=> rewriteHandler(post.post_id, textarea);
    const btnSave = document.createElement('button'); btnSave.className='btn-sm btn-save'; btnSave.innerText='üíæ L∆∞u & C·∫≠p nh·∫≠t';
    btnSave.onclick = ()=> saveHandler(post, card);

    actions.appendChild(btnEdit); actions.appendChild(btnRewrite); actions.appendChild(btnSave);

    right.appendChild(grid);
    right.appendChild(capLabel);
    right.appendChild(textarea);
    right.appendChild(stats);
    right.appendChild(actions);

    card.appendChild(left);
    card.appendChild(right);
    cardWrap.appendChild(card);
    wrap.appendChild(cardWrap);

    // initial stats
    updateStats(post.post_id, textarea.value);
  });

  // apply filter after render
  applyFilter(CURRENT_FILTER);
}

/* update word/char counts */
function updateStats(id, text){
  const words = text.trim()? text.trim().split(/\s+/).length : 0;
  const chars = text.length;
  const wEl = document.getElementById(`wc_${id}`);
  const cEl = document.getElementById(`cc_${id}`);
  if(wEl) wEl.innerText = words;
  if(cEl) cEl.innerText = chars;
}

/* filter UI */
document.getElementById('filterBar').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip');
  if(!chip) return;
  const plat = chip.dataset.plat || 'all';
  CURRENT_FILTER = plat;
  document.querySelectorAll('#filterBar .chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  applyFilter(plat);
});
function applyFilter(plat){
  document.querySelectorAll('#postList .card-wrap').forEach(w=>{
    if(plat==='all'){ w.style.display='block'; return; }
    const cls = 'platform-'+plat.toLowerCase();
    w.style.display = w.classList.contains(cls) ? 'block' : 'none';
  });
}

/* Save: gather inputs/selects inside the same card */
async function saveHandler(post, cardElement){
  const postId = post.post_id;
  // find the cardWrap by searching for the card that contains the textarea cap_{id}
  const textarea = document.getElementById(`cap_${postId}`);
  if(!textarea){ alert('Kh√¥ng t√¨m caption'); return; }
  // collect payload
  const payload = { post_id: postId };
  payload['Post Content'] = textarea.value;
  // time input
  const timeInput = document.querySelector(`input[type="time"][data-time="${postId}"]`);
  if(timeInput) payload['Plan Time'] = timeInput.value;

  // fields selects/inputs (data-field + data-post)
  document.querySelectorAll(`[data-post="${postId}"]`).forEach(el=>{
    const key = el.getAttribute('data-field');
    if(!key) return;
    if(el.tagName.toLowerCase() === 'select' || el.tagName.toLowerCase() === 'input'){
      // map to sheet columns naming if necessary
      if(key === 'topic') payload['Topic'] = el.value;
      else if(key === 'goal') payload["Post's goal"] = el.value;
      else if(key === 'style') payload['Desired style'] = el.value;
      else if(key === 'audience') payload['Target audience'] = el.value;
      else if(key === 'format') payload['Output Format'] = el.value;
      else payload[key] = el.value;
    }
  });

  // send update
  try{
    const res = await fetch(API_UPDATE, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    alert('‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng');
    await refreshAll(); // reflect changes
  }catch(err){
    console.error('saveHandler', err);
    alert('L∆∞u th·∫•t b·∫°i: ' + err.message);
  }
}

/* Rewrite handler (call AI) */
async function rewriteHandler(postId, textarea){
  const overlay = document.getElementById('overlay');
  try{
    overlay.style.display = 'flex';
    const res = await fetch(API_REWRITE, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ post_id: postId })
    });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if(json.caption){
      textarea.value = json.caption;
      updateStats(postId, json.caption);
    } else {
      throw new Error('API rewrite tr·∫£ v·ªÅ kh√¥ng c√≥ caption');
    }
  }catch(err){
    console.error('rewriteHandler', err);
    alert('Rewrite th·∫•t b·∫°i: ' + err.message);
  }finally{
    overlay.style.display = 'none';
  }
}

/* refresh both fields + posts */
async function refreshAll(){
  await loadFields();
  await loadPosts();
}

/* init */
document.getElementById('btnRefresh').addEventListener('click', refreshAll);
window.addEventListener('load', ()=>{
  refreshAll();
});
</script>
</body>
</html>
